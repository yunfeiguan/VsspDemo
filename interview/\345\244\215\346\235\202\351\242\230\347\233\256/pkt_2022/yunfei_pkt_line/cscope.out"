cscope 15 $HOME/èµ„æ–™/interview/è‡ªå·±å®žéªŒ/pkt_2022/yunfei_pkt_line -q 0000000047 0000003250
	@main.c

1 
	~<¡ršg.h
>

2 
	~<¡dlib.h
>

3 
	~<¡dio.h
>

5 
	#MAX_PACKAGE_SIZE
 65520

	)

6 
	#MAX_PAYLOAD_SIZE
 65516

	)

8 
	gbufãr
[
MAX_PACKAGE_SIZE
] = {'0'};

9 
	g¡Ý
 = 0;

11 
	$u§ge
(*
´oc
)

13 
	`´štf
("Error: should…ass 2‡rguments‡t†east!\n\n");

14 
	`´štf
("eg.\n");

15 
	`´štf
(" c© fže.xx | % <--decod| --’code> \n\n", 
´oc
);

16 
	}
}

18 
	$´št_to_¡dout
(*
buf
, 
size
)

20 
c
 = '0';

21 
i
 = 0;

22 (
c
 =*(
buf
++)è!ð'\n' && 
i
++ < 
size
)

23 
	`´štf
("%c", 
c
);

24 ià(
c
 == '\n')

25 
	`´štf
("\n");

26 
	}
}

28 
	$»adlše2
(*
lše
, 
max_size
)

30 
c
;

31 
Ën
 = 0;

32 
Ën
 < 
max_size
 && (
c
 = 
	`g‘c
(
¡dš
)) != '\n') {

33 if(
EOF
 =ð
c
) {

34 
¡Ý
 = 1;

37 
lše
[
Ën
++] = 
c
;

41 ià(
Ën
 =ð0 && 
c
 == '\n')

42 
lše
[
Ën
++] = '\n';

44 if(
Ën
 >0 &&†’ < 
max_size
 && 
c
 !ð
EOF
)

45 
lše
[
Ën
++] = '\n';

47  
Ën
;

48 
	}
}

50 
	$£t_¡r_h—d”
(*
buf
, 
size
)

52 
i
 = 0;

53 
hexch¬
[] = "0123456789abcdef";

55 
i
 = 0; i < 4; i++)

56 
buf
[
i
] = 
hexch¬
[(
size
 >> 4*(4-i-1)) % 16];

57 
	}
}

59 
	$hex¡r_to_Ëngth
(*
hex¡r
) {

60 
hexch¬
[] = "0123456789abcdef";

63 
sum
 = 0, 
j
 = 0, 
i
 =0;

64 
i
 = 0; i < 4; i++) {

65 
hex¡r
[
i
] !ð
hexch¬
[
j
++]);

66 
sum
 |ð(
j
-1è<< 4*(4-
i
-1);

67 
j
 = 0;

70  
sum
;

71 
	}
}

72 
	$·ck
(*
fÜm©_¡r
, *
buf
, 
Ën
)

74 ià(
Ën
 =ð1 && 
buf
[0] == '\n') {

75 
	`´štf
("%s", 
buf
);

79 
	`£t_¡r_h—d”
(
fÜm©_¡r
, 
Ën
+4);

80 
	`memýy
(
fÜm©_¡r
+4, 
buf
, 
Ën
);

81 
	`´št_to_¡dout
(
fÜm©_¡r
, 
Ën
+4);

83 
	}
}

85 
	$’code
(
¬gc
, **
¬gv
)

87 
Ën
 = 0, 
i
 = 0;

88 
fÜm©_¡r
[
MAX_PACKAGE_SIZE
] = {'\0'};

89 ià(
¬gc
) {

90 
i
 < 
¬gc
) {

91 
Ën
 = 
	`¡¾’
(
¬gv
[
i
]);

92 
	`·ck
(
fÜm©_¡r
, 
¬gv
[
i
], 
Ën
);

93 
	`´štf
("\n");

94 
i
++;

97 (
Ën
 = 
	`»adlše2
(
bufãr
, 
MAX_PAYLOAD_SIZE
)) ) {

98 
	`·ck
(
fÜm©_¡r
, 
bufãr
, 
Ën
);

99 
	`fæush
(
¡dout
);

100 
	`mem£t
(
bufãr
, '\0', 
MAX_PAYLOAD_SIZE
+1);

102 ià(
¡Ý
)

106 
	`´štf
("0000");

108 
	}
}

110 
	$uÅack
(*
fÜm©_¡r
, *
buf
)

112 
h—d
[5] = {'\0'};

113 
Ën
 = 0;

114 
	`¡ºýy
(
h—d
, 
buf
, 4);

117 ià(
buf
[0] == '\n') {

118 
	`´štf
("%s", 
buf
);

122 
Ën
 = 
	`hex¡r_to_Ëngth
(
h—d
) - 4;

124 ià(
	`¡ºcmp
(
buf
, "0004", 4) <= 0 && strncmp(buf, "0000", 4) > 0) {

129 ià(
	`¡ºcmp
("0000", 
buf
, 4) == 0) {

134 
	`memýy
(
fÜm©_¡r
, 
buf
+4, 
Ën
);

135 
	`´št_to_¡dout
(
fÜm©_¡r
, 
Ën
);

137 
	}
}

139 
	$decode
(
¬gc
, **
¬gv
)

141 
Ën
 = 0, 
i
 = 0;

142 
fÜm©_¡r
[
MAX_PACKAGE_SIZE
] = {'\0'};

143 ià(
¬gc
) {

144 
i
 < 
¬gc
) {

145 
	`uÅack
(
fÜm©_¡r
, 
¬gv
[
i
]);

146 
	`´štf
("\n");

147 
i
++;

150 (
Ën
 = 
	`»adlše2
(
bufãr
, 
MAX_PACKAGE_SIZE
))) {

151 if(
	`uÅack
(
fÜm©_¡r
, 
bufãr
))

154 ià(
¡Ý
)

159 
	}
}

161 
	$maš
(
¬gc
, **
¬gv
)

163 ià(
¬gc
 < 2) {

164 
	`u§ge
(
¬gv
[0]);

168 
	`äeÝ’
(
NULL
, "rb", 
¡dš
);

169 ià(
	`¡rcmp
(
¬gv
[1],"--encode") == 0)

170 
	`’code
(
¬gc
-2, 
¬gv
+2);

171 ià(
	`¡rcmp
(
¬gv
[1], "--decode") == 0)

172 
	`decode
(
¬gc
-2, 
¬gv
+2);

174 
	`´štf
("šv®id©Ýy³: %s\n", 
¬gv
[1]);

175 
	`u§ge
(
¬gv
[1]);

180 
	}
}

	@
1
.
0
1
7
main.c
